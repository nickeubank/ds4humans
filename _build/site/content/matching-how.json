{"kind":"Notebook","sha256":"a60208e4ca691ec54e5ec87a90c18082518d08fa03b45eb42de01fa3b1dfbd8e","slug":"matching-how","location":"/35_causal/90_matching_how.ipynb","dependencies":[],"frontmatter":{"title":"How to Match","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3","language":"python"},"authors":[{"nameParsed":{"literal":"Nick Eubank","given":"Nick","family":"Eubank"},"name":"Nick Eubank","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/nickeubank/ds4humans","copyright":"2025","thumbnail":"/matching_king_1-9194c9cd0840ee78c52aaa30bbd4be6f.png","exports":[{"format":"ipynb","filename":"90_matching_how.ipynb","url":"/90_matching_how-5628a8328992f2184ea44a628af202cd.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"In this reading, I’ll give a high level summary of how matching works before referring to a youtube lesson a the nitty gritty of a few specific implementations.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uOd0v1aswE"}],"key":"E9Z9HHpPOa"}],"key":"Iv4Uk1c7lr"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Pruning Your Data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eTBi4wSqyh"}],"identifier":"pruning-your-data","label":"Pruning Your Data","html_id":"pruning-your-data","implicit":true,"key":"a8bXxnUjtx"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"As noted in our last reading (this reading is a follow-on to ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"tO9dxIuWfi"},{"type":"link","url":"/matching-why","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The Why of Matching","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jOvKClrtRu"}],"urlSource":"80_matching_why.ipynb","dataUrl":"/matching-why.json","internal":true,"protocol":"file","key":"lqeI17rQAg"},{"type":"text","value":", so if you haven’t read that start there), matching could be more appropriately called “pruning”, as the goal is to winnow down your dataset until you have a set of observations for which your control and treatment variables look very similar in terms of observable characteristics. So how do we do that?","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hEM40NCQxL"}],"key":"cQOWIdkYlA"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"A simple matching algorithm would proceed like this:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"USUum1w8wK"}],"key":"sN28woNMVF"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Loop over all your treated observations.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ow68BpqlcM"}],"key":"nkxpQRnbse"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"For each treated observation, look for the most similar untreated observation (not already in a pair) in terms of your control variables.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"nJG9Gm8Qfo"}],"key":"ommcQWzeWO"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"If that untreated observation is too dissimilar to the treated observation, throw away the treated observation. (As the user you have to pick a threshold for how dissimilar is ok.)","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"NTL4n9YkVh"}],"key":"PgWNP0jptR"},{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"If not, call them a pair and keep both.","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"DILls6rU6x"}],"key":"GmJNcrRPoY"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"When you’ve finished looping over your treated observations, throw away any unpaired untreated observations.","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"IyvvmtMQF1"}],"key":"Cks2dRjbtK"}],"key":"dxTo4j5kzh"},{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"When you’re done, you’ll have a collected of pairs of observations (one treated, one untreated), where both members of each pair are very similar in terms of their observable control variables. All other data has been thrown away.","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"cLPgvfQIrZ"}],"key":"ax2SDNU0S1"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"To illustrate with the example from the last reading, if we started with this data:\n","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"w6sGGUoc0g"},{"type":"image","url":"/matching_king_1-9194c9cd0840ee78c52aaa30bbd4be6f.png","alt":"matching_king_1","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"oDPs1vP5X3","urlSource":"images/matching_king_1.png"}],"key":"eVHUtK5Qu8"},{"type":"paragraph","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"A simple matching algorithm would probably prune it down to something like this:","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"SrmOefpUuY"}],"key":"JFIzcDzaHu"},{"type":"image","url":"/matching_king_4-a16465012df4481f908edeb7e9eb821a.png","alt":"matching_king_4","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"ymGVNT8Lxu","urlSource":"images/matching_king_4.png"}],"key":"NrwOAhANlF"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Then, and here’s the cool part, you take this dataset and analyze just the way you would otherwise! Just run your regression on this dataset!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ybKH99H9ao"}],"key":"IfwV3D5cWW"}],"key":"i2MxMfBBhv"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Measuring Similarity","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zQDz216D5I"}],"identifier":"measuring-similarity","label":"Measuring Similarity","html_id":"measuring-similarity","implicit":true,"key":"HUdzE08yRj"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The biggest decision you have to make when doing matching is deciding how you want to measure whether two observations are “similar”. The most simple, commonly used strategy is to measure the dissimilarity of two observations in a pair by:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"rLqeiU3Wjv"}],"key":"k1xLliy81C"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"For each control variable, calculate the difference between the two observations in the pair (so if one has Education of 20 and one of 14, you’d get 6). Note the example above just has Education, but in reality you likely have dozens of these variables, so you do this for each variable.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"EsZeaQx17Y"}],"key":"vQwGt3f6KE"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Normalize those differences by the standard deviation of the variable (so divide 6 by the standard deviation of Education)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"b1I1hwfbIW"}],"key":"fVDjZsZmC9"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Square all those differences, add them up, and take the square root. That’s your “similarity” score.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"o76RnQfQNz"}],"key":"cLowDmmrZY"}],"key":"lkd0MurWuq"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Basically, this is like taking the euclidean distance between the points in some really high dimensional space, except you also normalize distances by their standard deviation, a strategy called “Mahalanobis Distance Matching”.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"h2XQoSiQRT"}],"key":"lKr9LEoQlE"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Of course it’s not the only strategy -- the video linked at the bottom of this reading will direct you to a talk on three very good strategies, as well as their strengths and weaknesses -- but that’s generally the idea.","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"xQtwaynt5n"}],"key":"YstNQIpcM5"}],"key":"NA2QrH6ZIv"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"When Can / Should I Use Matching?","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"c7khnc8VzX"}],"identifier":"when-can-should-i-use-matching","label":"When Can / Should I Use Matching?","html_id":"when-can-should-i-use-matching","implicit":true,"key":"GIf84NW5kX"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Matching is best used in a somewhat odd situation: a place where you have some overlap in what your treated and untreated observations look like (called having “common support”),  but where you also have some areas where they ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"kZCdw8p0Oi"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"don’t","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WBWFO7cRKS"}],"key":"Q3r7Ga5uv2"},{"type":"text","value":" overlap (imbalance).","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"KnSnH6CXeB"}],"key":"ZXjeeC84nb"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The first is necessary because when you prune your data, the goal is to keep only observations that look similar, so you need ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"dtr8p88pQW"},{"type":"emphasis","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"some","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"GdVxrSwN6Z"}],"key":"dOtF1Tfij3"},{"type":"text","value":" area of overlap, or you won’t have anything to match!","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"PRT0C873fk"}],"key":"Glj5fV5iwh"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"At the same time, however, if there’s ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"KSZVX8En8N"},{"type":"emphasis","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"no","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ZnVFxEDU0E"}],"key":"Yp4Ew4WrGr"},{"type":"text","value":" imbalance, then you don’t really need to do matching.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ZLcNpvWw2A"}],"key":"UF4RpDXTHP"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"So when should you use it? When your distributions have ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"duXudUblw9"},{"type":"strong","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"both","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"yc4ryLU3PP"}],"key":"n98q7y9ZgM"},{"type":"text","value":" areas of overlap and areas of imbalance.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"qpllzffSm6"}],"key":"XYx9bXbhwf"}],"key":"eZUnCcvQZL"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Checking Balance","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OyIQMubwXu"}],"identifier":"checking-balance","label":"Checking Balance","html_id":"checking-balance","implicit":true,"key":"u2tXGMQqTR"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"There’s a balance you have to strike when matching: the more strict you are about the maximium dissimilarity you’re willing to include before you throw out a pair of observations, the more balanced your final dataset will be, but the smaller your dataset will be do.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VEEvBAyiLR"}],"key":"uDZ3T0RkXo"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Right? If you reject any pairs that aren’t almost exactly identical, you’ll end up with less data, but what’s left will be more balanced.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"fT7n5XpQ3x"}],"key":"pmCLWfuQwv"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"So for your application, you have to decide on whether it’s better to have the statistical power of more observations, or the better balance from fewer.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"mglZUEumhG"}],"key":"oPEmuJMkpH"}],"key":"SlnyCUc5yP"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Analyze!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RNSj24e85b"}],"identifier":"analyze","label":"Analyze!","html_id":"analyze","implicit":true,"key":"xiksoBdhiB"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Now the best part of matching: now you just do do what you would have done normally.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"JWI31ZGvhL"}],"key":"CrJYhOJr53"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"In other words, you can think of this as a kind of “pre-processing step”, and now you can carry forward by feeding this into a regression just the way you would with the original data.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"iDrFYApjWP"}],"key":"zQ9cPGMhsu"}],"key":"XXkkOCN4Hs"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Specific Models","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kwcSUMEmUP"}],"identifier":"specific-models","label":"Specific Models","html_id":"specific-models","implicit":true,"key":"rA1tpY0tDs"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"OK, for the details of a few common models, please go watch this great video by Gary King -- you can probably start 15 minuntes in, and should watch till at least 45 minutes, though what follows is also really interesting!","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"YkO5ABwCA0"}],"key":"iSHwcKzmNx"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"link","url":"https://youtu.be/tvMyjDi4dyg?t=910","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Gary King on Matching","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"YEbDuhdYV2"}],"urlSource":"https://youtu.be/tvMyjDi4dyg?t=910","key":"qGlNaiSzgg"}],"key":"yzvPsnJg8L"}],"key":"mDSvIXIRPO"}],"key":"D5I8fmenoV"},"references":{"cite":{"order":[],"data":{}}}}